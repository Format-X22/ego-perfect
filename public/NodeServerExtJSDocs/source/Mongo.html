<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='B-Mongo'>/**
</span> * Класса доступа к базе данных.
 * Обеспечивает легкую прослойку над апи драйвера Mongo.
 * Также занимается подключением и переподключением.
 */
Ext.define(&#39;B.Mongo&#39;, {
    singleton: true,

    config: {

<span id='B-Mongo-cfg-dataBaseLink'>        /**
</span>         * @cfg {String} dataBaseLink (required) Ссылка для подключения к базе.
         */             
        dataBaseLink: &#39;&#39;,

<span id='B-Mongo-cfg-reconnectTime'>        /**
</span>         * @cfg {Number} reconnectTime Время до переподключения к базе.
         */
        reconnectTime: 10 * 1000,

<span id='B-Mongo-cfg-mongoDriver'>        /**
</span>         * @cfg {Object} mongoDriver Объект драйвера Mongo.
         */
        mongoDriver: require(&#39;mongodb&#39;),

<span id='B-Mongo-cfg-mongoClient'>        /**
</span>         * @cfg {Object} mongoClient Клиент драйвера Mongo для подключения к базе.
         */
        mongoClient: null,

<span id='B-Mongo-cfg-dataBase'>        /**
</span>         * @cfg {Object} dataBase Объект базы данных.
         */
        dataBase: null,

<span id='B-Mongo-cfg-objectIdMaker'>        /**
</span>         * @cfg {Function} objectIdMaker Нативный генератор Mongo ObjectID для указанного значения.
         */
        objectIdMaker: null,

<span id='B-Mongo-cfg-requestErrorText'>        /**
</span>         * @cfg {String} requestErrorText Текст ошибки запроса к базе данных.
         */
        requestErrorText: &#39;Ошибка запроса к базе данных!&#39;
    },

<span id='B-Mongo-method-constructor'>    constructor: function () {
</span>        this.initConfig(this.config);
        this.setMongoClient(this.getMongoDriver().MongoClient);
        this.setObjectIdMaker(this.getMongoDriver().ObjectID);
    },

<span id='B-Mongo-method-connect'>    /**
</span>     * Подключение к базе данных.
     * @param {Function} [callback] Следующий шаг.
     */
    connect: function (callback) {
        callback = callback || Ext.emptyFn;

        if (!this.getDataBaseLink()) {
            callback();
            return;
        }

        this.getMongoClient().connect(this.getDataBaseLink(), function (error, db) {
            if (error) {
                this.logConnectError(error);
                this.tryReconnect(callback);
            } else {
                this.setDataBase(db);
                this.logConnectEstablished();
                callback();
            }
        }.bind(this));
    },

<span id='B-Mongo-method-getCollection'>    /**
</span>     * Получение доступа к конкретной коллекции базы данных.
     * @param {String} collection Имя коллекции.
     * @return {Object} Объект коллекции.
     */
    getCollection: function (collection) {
        var db = this.getDataBase();

        if (db) {
            return db.collection(collection);
        } else {
            this.logDataBaseNotFound();
            this.connect();

            return null;
        }
    },

<span id='B-Mongo-method-makeId'>    /**
</span>     * Создает Mongo ObjectID по указанному значению.
     * @param {String} value Значение для превращения в ObjectID.
     * @return {Mongo.ObjectID} Mongo ObjectID.
     */
    makeId: function (value) {
        return this.getObjectIdMaker()(value);
    },

<span id='B-Mongo-property-privates'>    privates: {
</span>
<span id='B-Mongo-method-tryReconnect'>        /**
</span>         * @private
         * Попытка переподключения через {@link #cfg-reconnectTime} милисекунд.
         * @param {Function} callback Следующий шаг.
         */
        tryReconnect: function (callback) {
            Ext.defer(
                this.connect.bind(this, callback),
                this.getReconnectTime()
            );
        },

<span id='B-Mongo-method-logConnectError'>        /**
</span>         * @private
         * @param {Object} error Объект ошибки базы данных.
         */
        logConnectError: function (error) {
            Ext.log({
                level: &#39;error&#39;,
                msg: &#39;Невозможно подключиться к базе!\n\n&#39; + error
            });
        },

<span id='B-Mongo-method-logConnectEstablished'>        /**
</span>         * @private
         */
        logConnectEstablished: function () {
            Ext.log({
                level: &#39;info&#39;,
                msg: &#39;Соединение с базой данных установлено.&#39;
            });
        },

<span id='B-Mongo-method-logDataBaseNotFound'>        /**
</span>         * @private
         */
        logDataBaseNotFound: function () {
            Ext.log({
                level: &#39;error&#39;,
                msg: &#39;Объект базы не существует! Попытка переподключения...&#39;
            });
        }
    }
});</pre>
</body>
</html>
